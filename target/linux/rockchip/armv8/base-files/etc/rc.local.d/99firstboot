#!/bin/sh

WIFIDEVICE="platform/fe2c0000.mmc/mmc_host/mmc2/mmc2:0001/mmc2:0001:1"

if [ ! -d "/sys/devices/${WIFIDEVICE}" ]; then
    exit 0
fi

RETRY_COUNT=0

while [ ${RETRY_COUNT} -le 60 ]; do
    MACADDR=$(cat "/sys/devices/${WIFIDEVICE}/net/"*/address | tail -n 1 | awk '{gsub(/:/,""); print tolower($0)}')
    RETRY_COUNT=$(expr ${RETRY_COUNT} + 1)

    if [ x"${MACADDR}" != x"" ]; then
        break
    fi

    sleep 5
done

if [ x"${MACADDR}" = x"" ]; then
    exit 0
fi

WIFISSID="photonicat-${MACADDR:4:8}"

rm -f /etc/config/wireless 2>/dev/null || true

echo "config wifi-device 'radio0'" >/etc/config/wireless
echo "" >>/etc/config/wireless
echo "config wifi-iface 'default_radio0'" >>/etc/config/wireless

uci set wireless.radio0.disabled=0
uci set wireless.radio0.type=mac80211
uci set wireless.radio0.country=US
uci set wireless.radio0.path="${WIFIDEVICE}"
uci set wireless.default_radio0.device=radio0
uci set wireless.default_radio0.ssid="${WIFISSID}"
uci set wireless.radio0.channel=11
uci set wireless.radio0.band=2g
uci set wireless.radio0.htmode=HT20
uci set wireless.default_radio0.network=lan
uci set wireless.default_radio0.mode=ap
uci set wireless.default_radio0.encryption=psk2
uci set wireless.default_radio0.key=photonicat
uci set wireless.default_radio0.wps_pushbutton=0
uci set wireless.default_radio0.disassoc_low_ack=0
uci commit
wifi reload
sleep 3
wifi config
wifi reconf
wifi

uci set luci.main.lang=zh_tw
uci commit luci

uci set system.@system[0].timezone=CST-8
uci set system.@system[0].zonename=Asia/Taipei
uci set system.@system[0].hostname=photonicat-openwrt
uci commit system
hostname photonicat-openwrt

/etc/init.d/modemmanager enable
/etc/init.d/modemmanager start

sleep 3

# patch modemmanager for sourcefilter
mv /lib/netifd/proto/modemmanager.sh /lib/netifd/proto/modemmanager.sh.origin
cp /usr/share/patch/modemmanager.proto /lib/netifd/proto/modemmanager.sh

uci set network.wan.metric='512'
uci set network.wan6.sourcefilter='0'
uci set dhcp.lan.ra_default='2'

uci set network.wwan=interface
uci set network.wwan.proto='modemmanager'
uci set network.wwan.device='/sys/devices/platform/fd000000.usb/xhci-hcd.1.auto/usb7/7-1'
uci set network.wwan.apn='internet'
uci set network.wwan.auth='none'
uci set network.wwan.iptype='ipv4v6'
uci set network.wwan.metric='1024'
uci set network.wwan.sourcefilter='0'
uci set network.wwan.delegate='0'
uci commit
/etc/init.d/network restart

uci add_list firewall.@zone[1].network='wwan'
uci set firewall.@zone[1].masq6='1'
uci commit firewall
/etc/init.d/firewall restart

# disable watchcat by default
echo > /etc/config/watchcat
/etc/init.d/watchcat restart

rm -f /etc/rc.local.d/99firstboot

sleep 3
